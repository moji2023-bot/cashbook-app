<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Trade Payables & Receivables Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 16px; }
    h2, h3 { color: #223366; }
    table { width: 100%; background:#fff; border-radius:7px; overflow: hidden; margin-bottom:10px;}
    th, td { border-bottom: 1px solid #eee; padding: 6px 4px;}
    th { background: #e5edf6; }
    .payable { color: #b04848; font-weight: bold; }
    .receivable { color: #259c52; font-weight: bold; }
    .summary-table { background: #fff; padding: 12px; border-radius: 6px; box-shadow: 0 1px 4px #ccc; }
    .btn { padding: 5px 12px; border-radius: 4px; border: none; background: #2c5282; color: #fff; cursor: pointer;}
    .btn:hover { background: #466db3; }
    input, select { margin: 3px;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h2>Trade Payables & Receivables</h2>
  <form id="entryForm">
    Name: <input type="text" id="name" required>
    Amount: <input type="number" step="0.01" id="amount" required>
    Type: 
    <select id="type">
      <option value="Receivable">Received (They paid me)</option>
      <option value="Payable">Paid (I paid them)</option>
    </select>
    <button type="button" class="btn" onclick="addEntry()">Add Entry</button>
  </form>

  <hr>
  <h3>Set/Change Individual Opening Balances</h3>
  <form id="openingForm">
    Name: <input type="text" id="openingName" required>
    Opening Balance: <input type="number" step="0.01" id="openingBalance" required>
    <button type="button" class="btn" onclick="setOpening()">Set Opening</button>
  </form>

  <hr>
  <h3>All Entries</h3>
  <table>
    <thead>
      <tr>
        <th>Date & Time</th>
        <th>Name</th>
        <th>Type</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="entriesBody"></tbody>
  </table>

  <h3>Summary</h3>
  <table class="summary-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Opening(₹)</th>
        <th>Received(₹)</th>
        <th>Paid(₹)</th>
        <th>Balance(₹)</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
  <button class="btn" onclick="exportPDF()">Export All Data as PDF</button>

<script>
  let data = {
    entries: [],
    openings: {}
  };

  // Load saved data
  function loadData() {
    const saved = localStorage.getItem("tradebook_data");
    if(saved) data = JSON.parse(saved);
  }

  // Save to localStorage
  function saveData() {
    localStorage.setItem("tradebook_data", JSON.stringify(data));
  }

  function addEntry() {
    const name = document.getElementById('name').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);
    const type = document.getElementById('type').value;
    if (!name || isNaN(amount) || amount <= 0) {
      alert("Please enter a valid name and amount.");
      return;
    }
    const now = new Date();
    const timestamp = now.toLocaleString();
    data.entries.push({name, amount, type, timestamp});
    saveData();
    showEntries();
    showSummary();
    document.getElementById('entryForm').reset();
  }

  function setOpening() {
    const name = document.getElementById('openingName').value.trim();
    const opening = parseFloat(document.getElementById('openingBalance').value);
    if (!name || isNaN(opening)) {
      alert("Enter valid name and amount");
      return;
    }
    data.openings[name] = opening;
    saveData();
    showSummary();
    document.getElementById('openingForm').reset();
  }

  function showEntries() {
    const body = document.getElementById('entriesBody');
    body.innerHTML = '';
    data.entries.forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.timestamp}</td>
        <td>${entry.name}</td>
        <td class="${entry.type === 'Receivable' ? 'receivable' : 'payable'}">${entry.type}</td>
        <td>₹${entry.amount.toFixed(2)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function showSummary() {
    // Calculate per person: opening, total received, total paid, balance
    const summary = {};
    Object.keys(data.openings).forEach(name => {
      summary[name] = { opening: data.openings[name], received: 0, paid: 0, balance: data.openings[name] };
    });
    data.entries.forEach(entry => {
      if (!(entry.name in summary)) {
        summary[entry.name] = { opening: 0, received: 0, paid: 0, balance: 0 };
      }
      if (entry.type === "Receivable") {
        summary[entry.name].received += entry.amount;
        summary[entry.name].balance -= entry.amount; // Receiving reduces debt
      } else {
        summary[entry.name].paid += entry.amount;
        summary[entry.name].balance += entry.amount; // Payment increases debt
      }
    });
    const body = document.getElementById('summaryBody');
    body.innerHTML = '';
    Object.keys(summary).forEach(name => {
      const s = summary[name];
      body.innerHTML += `
        <tr>
          <td>${name}</td>
          <td>${s.opening.toFixed(2)}</td>
          <td class="receivable">${s.received.toFixed(2)}</td>
          <td class="payable">${s.paid.toFixed(2)}</td>
          <td style="font-weight:bold; color:${s.balance<=0?'#259c52':'#b04848'}">
            ${s.balance<=0?'+':'-'}₹${Math.abs(s.balance).toFixed(2)}
          </td>
        </tr>
      `;
    });
  }

  // PDF Export
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 15;
    doc.setFontSize(16);
    doc.text("Trade Payables & Receivables Report", 14, y);
    y += 6;
    doc.setFontSize(10);
    doc.text("Summary", 14, y);
    y += 6;
    // Summary table
    doc.autoTable && doc.autoTable({ // If using jsPDF autotable plugin
      head: [['Name','Opening','Received','Paid','Balance']],
      body: Object.keys(data.openings).map(name => {
        let s = { opening: data.openings[name], received: 0, paid: 0, balance: data.openings[name] };
        data.entries.forEach(entry=>{
          if(entry.name===name) {
            if (entry.type === "Receivable") {
              s.received += entry.amount; s.balance -= entry.amount;
            } else {
              s.paid += entry.amount; s.balance += entry.amount;
            }
          }
        });
        return [
          name,
          s.opening.toFixed(2),
          s.received.toFixed(2),
          s.paid.toFixed(2),
          (s.balance<=0?'+':'-')+"₹"+Math.abs(s.balance).toFixed(2)
        ];
      }),
      startY:y, margin:{left:14}
    });
    if (!doc.autoTable) { // Fallback: simple text
      Object.keys(data.openings).forEach(name=>{
        let s = { opening: data.openings[name], received: 0, paid: 0, balance: data.openings[name] };
        data.entries.forEach(entry=>{
          if(entry.name===name) {
            if (entry.type === "Receivable") { s.received+=entry.amount;s.balance-=entry.amount; }
            else { s.paid+=entry.amount;s.balance+=entry.amount;}
          }
        });
        y+=6; doc.text(`${name} | Opening: ${s.opening.toFixed(2)} | Received: ${s.received.toFixed(2)} | Paid: ${s.paid.toFixed(2)} | Balance: ${(s.balance<=0?'+':'-')+"₹"+Math.abs(s.balance).toFixed(2)}`, 14, y);
      });
    }
    y = doc.previousAutoTable ? doc.previousAutoTable.finalY + 10 : y + 15;

    doc.setFontSize(10);
    doc.text("All Entries", 14, y); y+=6;
    data.entries.forEach(entry=>{
      doc.text(`${entry.timestamp} | ${entry.name} | ${entry.type} | ₹${entry.amount.toFixed(2)}`,14,y);
      y+=5;
      if (y > 280) { doc.addPage(); y = 15; }
    });
    doc.save('TradeBook_Report.pdf');
  }

  // On-load: Try to load table and show it
  loadData();
  showEntries();
  showSummary();

  // Warn on data cleared
  window.onbeforeunload = function() {
    if (data.entries.length > 0) return "Navigating away will lose unsaved changes!";
  };
</script>
</body>
</html>
